#  进程

### 概述

进程是一个可执行程序的实例。

进程与程序的区别:  程序是包含了一系列信息的文件， 这些信息描述了如何在运行时创建一个进程， 所包含的内容如下:

- 二进制格式标识: 可执行文件格式的元信息(metainformation)。内核利用此信息来解释文件中其他信息。
- 机器语言指令: 对程序算法进行编码
- 程序入口地址: 标识程序开始执行时的起始指令位置。
- 数据: 程序文件包含的变量初始值和程序所使用的字面常量(比如字符串)
- 符号表及重定位表: 描述程序中函数与变量的位置与名称。用于调试和运行时的符号解析
- 共享库和动态连接信息: 列出程序运行所需要使用的共享库以及加载共享库的动态链接器的路径名

可以用一个程序来创建许多进程， 或反过来说， 许多进程运行的可以是同意程序。

进程是由内核定义的抽象实体， 并为该实体分配用以执行程序的系统资源。从内核角度看， 进程由内存空间和一系列内核数据结构组成， 其中用户内存空间包含了程序代码及代码所使用的变量， 而内核数据用于维护进程状态信息。

### 进程内存布局

每个进程所分配的内存由许多部分组成， 通常称之为"段"。 如下所示:

- 文本段：包含进程运行程序的机器语言指令。 文本段具有**只读**属性，防止进程通过错误指针修改。 **因为多个进程可同时运行同一程序**。一份程序代码拷贝可以映射到所有这些进程的虚拟地址空间中。
- 初始化数据段：包含显示初始化的全局变量和静态变量。当程序加载到内存时， 从可执行文件中读取这些值。
- 未初始化数据段：包含未显示初始化的全局变量和静态变量。程序启动后， 系统为本段内所有内存初始化为0. 通常称为**BSS段**。 之所以与初始化数据段区分， 由于程序在磁盘上存储时，**没有必要为未经初始化的变量分配存储空间**。只需记录其位置与所需大小。
- 栈：一个动态增长和收缩的段， 由栈帧组成。 系统会为每个当前调用的函数分配一个栈帧。 其中存储了函数的局部变量、实参与返回值。
- 堆：是在可运行时动态进行内存分配的一块区域。堆顶称作**program break**。

可使用`size`命令查看二进制可执行文件的文本段、初始化数据段、非初始化数据段的大小。





### 虚拟内存管理

### 进程的创建、退出、等待

<svg id="SvgjsSvg1298" width="435" height="620.3437881469727" xmlns="http://www.w3.org/2000/svg" version="1.1" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:svgjs="http://svgjs.com/svgjs"><defs id="SvgjsDefs1299"><marker id="SvgjsMarker1348" markerWidth="16" markerHeight="12" refX="16" refY="6" viewBox="0 0 16 12" orient="auto" markerUnits="userSpaceOnUse" stroke-dasharray="0,0"><path id="SvgjsPath1349" d="M0,2 L14,6 L0,11 L0,2" fill="#323232" stroke="#323232" stroke-width="2"></path></marker><marker id="SvgjsMarker1352" markerWidth="16" markerHeight="12" refX="16" refY="6" viewBox="0 0 16 12" orient="auto" markerUnits="userSpaceOnUse" stroke-dasharray="0,0"><path id="SvgjsPath1353" d="M0,2 L14,6 L0,11 L0,2" fill="#323232" stroke="#323232" stroke-width="2"></path></marker><marker id="SvgjsMarker1362" markerWidth="16" markerHeight="12" refX="16" refY="6" viewBox="0 0 16 12" orient="auto" markerUnits="userSpaceOnUse" stroke-dasharray="0,0"><path id="SvgjsPath1363" d="M0,2 L14,6 L0,11 L0,2" fill="#323232" stroke="#323232" stroke-width="2"></path></marker><marker id="SvgjsMarker1372" markerWidth="16" markerHeight="12" refX="16" refY="6" viewBox="0 0 16 12" orient="auto" markerUnits="userSpaceOnUse" stroke-dasharray="0,0"><path id="SvgjsPath1373" d="M0,2 L14,6 L0,11 L0,2" fill="#323232" stroke="#323232" stroke-width="2"></path></marker><marker id="SvgjsMarker1382" markerWidth="16" markerHeight="12" refX="16" refY="6" viewBox="0 0 16 12" orient="auto" markerUnits="userSpaceOnUse" stroke-dasharray="0,0"><path id="SvgjsPath1383" d="M0,2 L14,6 L0,11 L0,2" fill="#323232" stroke="#323232" stroke-width="2"></path></marker><marker id="SvgjsMarker1386" markerWidth="16" markerHeight="12" refX="16" refY="6" viewBox="0 0 16 12" orient="auto" markerUnits="userSpaceOnUse" stroke-dasharray="0,0"><path id="SvgjsPath1387" d="M0,2 L14,6 L0,11 L0,2" fill="#323232" stroke="#323232" stroke-width="2"></path></marker><marker id="SvgjsMarker1394" markerWidth="16" markerHeight="12" refX="16" refY="6" viewBox="0 0 16 12" orient="auto" markerUnits="userSpaceOnUse" stroke-dasharray="0,0"><path id="SvgjsPath1395" d="M0,2 L14,6 L0,11 L0,2" fill="#323232" stroke="#323232" stroke-width="2"></path></marker><marker id="SvgjsMarker1404" markerWidth="16" markerHeight="12" refX="16" refY="6" viewBox="0 0 16 12" orient="auto" markerUnits="userSpaceOnUse" stroke-dasharray="0,0"><path id="SvgjsPath1405" d="M0,2 L14,6 L0,11 L0,2" fill="#323232" stroke="#323232" stroke-width="2"></path></marker><marker id="SvgjsMarker1412" markerWidth="16" markerHeight="12" refX="16" refY="6" viewBox="0 0 16 12" orient="auto" markerUnits="userSpaceOnUse" stroke-dasharray="0,0"><path id="SvgjsPath1413" d="M0,2 L14,6 L0,11 L0,2" fill="#323232" stroke="#323232" stroke-width="2"></path></marker><marker id="SvgjsMarker1430" markerWidth="16" markerHeight="12" refX="16" refY="6" viewBox="0 0 16 12" orient="auto" markerUnits="userSpaceOnUse" stroke-dasharray="0,0"><path id="SvgjsPath1431" d="M0,2 L14,6 L0,11 L0,2" fill="#323232" stroke="#323232" stroke-width="2"></path></marker><marker id="SvgjsMarker1442" markerWidth="16" markerHeight="12" refX="16" refY="6" viewBox="0 0 16 12" orient="auto" markerUnits="userSpaceOnUse" stroke-dasharray="0,0"><path id="SvgjsPath1443" d="M0,2 L14,6 L0,11 L0,2" fill="#323232" stroke="#323232" stroke-width="2"></path></marker></defs><g id="SvgjsG1300" transform="translate(63,101.34375)"><path id="SvgjsPath1301" d="M 0 22C 0 -7.333333333333333 44 -7.333333333333333 44 22C 44 51.333333333333336 0 51.333333333333336 0 22Z" stroke="rgba(50,50,50,1)" stroke-width="2" fill-opacity="1" fill="#ffffff"></path><g id="SvgjsG1302"><text id="SvgjsText1303" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="24px" fill="#323232" font-weight="400" align="middle" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="12.05" transform="rotate(0)"><tspan id="SvgjsTspan1304" dy="16" x="22"><tspan id="SvgjsTspan1305" style="text-decoration:;">A</tspan></tspan></text></g></g><g id="SvgjsG1306" transform="translate(44,179.34375)"><path id="SvgjsPath1307" d="M 0 0L 82 0L 82 30L 0 30Z" stroke="rgba(50,50,50,1)" stroke-width="2" fill-opacity="1" fill="#ffffff"></path><g id="SvgjsG1308"><text id="SvgjsText1309" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="62px" fill="#323232" font-weight="400" align="middle" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="5.05" transform="rotate(0)"><tspan id="SvgjsTspan1310" dy="16" x="41"><tspan id="SvgjsTspan1311" style="text-decoration:;">fork()</tspan></tspan></text></g></g><g id="SvgjsG1312" transform="translate(34,321.34375)"><path id="SvgjsPath1313" d="M 0 0L 102 0L 102 30L 0 30Z" stroke="rgba(50,50,50,1)" stroke-width="2" fill-opacity="1" fill="#ffffff"></path><g id="SvgjsG1314"><text id="SvgjsText1315" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="82px" fill="#323232" font-weight="400" align="middle" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="-2.95" transform="rotate(0)"><tspan id="SvgjsTspan1316" dy="16" x="51"><tspan id="SvgjsTspan1317" style="text-decoration:;">wait(status)</tspan></tspan><tspan id="SvgjsTspan1318" dy="16" x="51"><tspan id="SvgjsTspan1319" style="text-decoration:;">可选</tspan></tspan></text></g></g><g id="SvgjsG1320" transform="translate(328,219.34375)"><path id="SvgjsPath1321" d="M 0 22C 0 -7.333333333333333 44 -7.333333333333333 44 22C 44 51.333333333333336 0 51.333333333333336 0 22Z" stroke="rgba(50,50,50,1)" stroke-width="2" fill-opacity="1" fill="#ffffff"></path><g id="SvgjsG1322"><text id="SvgjsText1323" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="24px" fill="#323232" font-weight="400" align="middle" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="12.05" transform="rotate(0)"><tspan id="SvgjsTspan1324" dy="16" x="22"><tspan id="SvgjsTspan1325" style="text-decoration:;">A</tspan></tspan></text></g></g><g id="SvgjsG1326" transform="translate(299,356.34375)"><path id="SvgjsPath1327" d="M 0 0L 102 0L 102 30L 0 30Z" stroke="rgba(50,50,50,1)" stroke-width="2" fill-opacity="1" fill="#ffffff"></path><g id="SvgjsG1328"><text id="SvgjsText1329" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="82px" fill="#323232" font-weight="400" align="middle" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="-2.95" transform="rotate(0)"><tspan id="SvgjsTspan1330" dy="16" x="51"><tspan id="SvgjsTspan1331" style="text-decoration:;">execve(B,...)</tspan></tspan><tspan id="SvgjsTspan1332" dy="16" x="51"><tspan id="SvgjsTspan1333" style="text-decoration:;">可选</tspan></tspan></text></g></g><g id="SvgjsG1334" transform="translate(328,431.34375)"><path id="SvgjsPath1335" d="M 0 22C 0 -7.333333333333333 44 -7.333333333333333 44 22C 44 51.333333333333336 0 51.333333333333336 0 22Z" stroke="rgba(50,50,50,1)" stroke-width="2" fill-opacity="1" fill="#ffffff"></path><g id="SvgjsG1336"><text id="SvgjsText1337" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="24px" fill="#323232" font-weight="400" align="middle" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="12.05" transform="rotate(0)"><tspan id="SvgjsTspan1338" dy="16" x="22"><tspan id="SvgjsTspan1339" style="text-decoration:;">B</tspan></tspan></text></g></g><g id="SvgjsG1340" transform="translate(309,565.34375)"><path id="SvgjsPath1341" d="M 0 0L 89 0L 89 30L 0 30Z" stroke-dasharray="3,4" stroke="rgba(50,50,50,1)" stroke-width="2" fill-opacity="1" fill="#ffffff"></path><g id="SvgjsG1342"><text id="SvgjsText1343" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="69px" fill="#323232" font-weight="400" align="middle" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="5.05" transform="rotate(0)"><tspan id="SvgjsTspan1344" dy="16" x="44.5"><tspan id="SvgjsTspan1345" style="text-decoration:;">exit(status)</tspan></tspan></text></g></g><g id="SvgjsG1346"><path id="SvgjsPath1347" d="M85 145.34375L85 162.34375L85 162.34375L85 179.34375" stroke="#323232" stroke-width="2" fill="none" marker-end="url(#SvgjsMarker1348)"></path></g><g id="SvgjsG1350"><path id="SvgjsPath1351" d="M85 209.34375L85 265.34375L85 265.34375L85 321.34375" stroke="#323232" stroke-width="2" fill="none" marker-end="url(#SvgjsMarker1352)"></path><rect id="SvgjsRect1354" width="104" height="32" x="33" y="249.34375" fill="#ffffff"></rect><text id="SvgjsText1355" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="104px" fill="#323232" font-weight="400" align="top" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="247.39375" transform="rotate(0)"><tspan id="SvgjsTspan1356" dy="16" x="85"><tspan id="SvgjsTspan1357" style="text-decoration:;">父进程可能于此处</tspan></tspan><tspan id="SvgjsTspan1358" dy="16" x="85"><tspan id="SvgjsTspan1359" style="text-decoration:;">执行其他动作</tspan></tspan></text></g><g id="SvgjsG1360"><path id="SvgjsPath1361" d="M85 209.34375L328 241.34375" stroke="#323232" stroke-width="2" fill="none" marker-end="url(#SvgjsMarker1362)"></path><rect id="SvgjsRect1364" width="91" height="32" x="161" y="209.34375" fill="#ffffff"></rect><text id="SvgjsText1365" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="91px" fill="#323232" font-weight="400" align="top" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="207.39375" transform="rotate(0)"><tspan id="SvgjsTspan1366" dy="16" x="206.5"><tspan id="SvgjsTspan1367" style="text-decoration:;">将父进程的内存</tspan></tspan><tspan id="SvgjsTspan1368" dy="16" x="206.5"><tspan id="SvgjsTspan1369" style="text-decoration:;">拷贝至子进程</tspan></tspan></text></g><g id="SvgjsG1370"><path id="SvgjsPath1371" d="M350 263.34375L350 356.34375" stroke="#323232" stroke-width="2" fill="none" marker-end="url(#SvgjsMarker1372)"></path><rect id="SvgjsRect1374" width="104" height="32" x="298" y="293.84375" fill="#ffffff"></rect><text id="SvgjsText1375" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="104px" fill="#323232" font-weight="400" align="top" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="291.89375" transform="rotate(0)"><tspan id="SvgjsTspan1376" dy="16" x="350"><tspan id="SvgjsTspan1377" style="text-decoration:;">子进程可能于此处</tspan></tspan><tspan id="SvgjsTspan1378" dy="16" x="350"><tspan id="SvgjsTspan1379" style="text-decoration:;">执行进一步动作</tspan></tspan></text></g><g id="SvgjsG1380"><path id="SvgjsPath1381" d="M350 386.34375L350 431.34375" stroke="#323232" stroke-width="2" fill="none" marker-end="url(#SvgjsMarker1382)"></path></g><g id="SvgjsG1384"><path id="SvgjsPath1385" d="M350 475.34375L353.5 565.34375" stroke="#323232" stroke-width="2" fill="none" marker-end="url(#SvgjsMarker1386)"></path><rect id="SvgjsRect1388" width="60" height="16" x="321.75" y="512.34375" fill="#ffffff"></rect><text id="SvgjsText1389" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="60px" fill="#323232" font-weight="400" align="top" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="510.39375" transform="rotate(0)"><tspan id="SvgjsTspan1390" dy="16" x="351.75"><tspan id="SvgjsTspan1391" style="text-decoration:;">执行程序B</tspan></tspan></text></g><g id="SvgjsG1392"><path id="SvgjsPath1393" d="M309 580.34375L85 351.34375" stroke-dasharray="3,3" stroke="#323232" stroke-width="2" fill="none" marker-end="url(#SvgjsMarker1394)"></path><rect id="SvgjsRect1396" width="78" height="32" x="158" y="449.84375" fill="#ffffff"></rect><text id="SvgjsText1397" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="78px" fill="#323232" font-weight="400" align="top" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="447.89375" transform="rotate(0)"><tspan id="SvgjsTspan1398" dy="16" x="197"><tspan id="SvgjsTspan1399" style="text-decoration:;">将子进程状态</tspan></tspan><tspan id="SvgjsTspan1400" dy="16" x="197"><tspan id="SvgjsTspan1401" style="text-decoration:;">传递给父进程</tspan></tspan></text></g><g id="SvgjsG1402"><path id="SvgjsPath1403" d="M85 351.34375L85 595.34375" stroke-dasharray="8,5" stroke="#323232" stroke-width="2" fill="none" marker-end="url(#SvgjsMarker1404)"></path><rect id="SvgjsRect1406" width="104" height="16" x="33" y="526.34375" fill="#ffffff"></rect><text id="SvgjsText1407" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="104px" fill="#323232" font-weight="400" align="top" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="524.39375" transform="rotate(0)"><tspan id="SvgjsTspan1408" dy="16" x="85"><tspan id="SvgjsTspan1409" style="text-decoration:;">挂起父进程的执行</tspan></tspan></text></g><g id="SvgjsG1410"><path id="SvgjsPath1411" d="M309 580.34375L90 580.34375" stroke-dasharray="3,3" stroke="#323232" stroke-width="2" fill="none" marker-end="url(#SvgjsMarker1412)"></path><rect id="SvgjsRect1414" width="130" height="32" x="134.5" y="564.34375" fill="#ffffff"></rect><text id="SvgjsText1415" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="130px" fill="#323232" font-weight="400" align="top" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="562.39375" transform="rotate(0)"><tspan id="SvgjsTspan1416" dy="16" x="199.5"><tspan id="SvgjsTspan1417" style="text-decoration:;">内核重新运行父进程并</tspan></tspan><tspan id="SvgjsTspan1418" dy="16" x="199.5"><tspan id="SvgjsTspan1419" style="text-decoration:;">发送信号SIGCHLD</tspan></tspan></text></g><g id="SvgjsG1420" transform="translate(25,25.010406494140625)"><path id="SvgjsPath1421" d="M 0 0L 120 0L 120 40L 0 40Z" stroke="none" fill="none"></path><g id="SvgjsG1422"><text id="SvgjsText1423" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="120px" fill="#323232" font-weight="400" align="middle" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="2.05" transform="rotate(0)"><tspan id="SvgjsTspan1424" dy="16" x="60"><tspan id="SvgjsTspan1425" style="text-decoration:;">父进程执行</tspan></tspan><tspan id="SvgjsTspan1426" dy="16" x="60"><tspan id="SvgjsTspan1427" style="text-decoration:;">程序A</tspan></tspan></text></g></g><g id="SvgjsG1428"><path id="SvgjsPath1429" d="M85 65.01040649414062L85 101.34375" stroke="#323232" stroke-width="2" fill="none" marker-end="url(#SvgjsMarker1430)"></path></g><g id="SvgjsG1432" transform="translate(290,129.34375)"><path id="SvgjsPath1433" d="M 0 0L 120 0L 120 40L 0 40Z" stroke="none" fill="none"></path><g id="SvgjsG1434"><text id="SvgjsText1435" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="120px" fill="#323232" font-weight="400" align="middle" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="2.05" transform="rotate(0)"><tspan id="SvgjsTspan1436" dy="16" x="60"><tspan id="SvgjsTspan1437" style="text-decoration:;">子进程执行</tspan></tspan><tspan id="SvgjsTspan1438" dy="16" x="60"><tspan id="SvgjsTspan1439" style="text-decoration:;">程序A</tspan></tspan></text></g></g><g id="SvgjsG1440"><path id="SvgjsPath1441" d="M350 169.34375L350 219.34375" stroke="#323232" stroke-width="2" fill="none" marker-end="url(#SvgjsMarker1442)"></path></g></svg>

![进程创建过程](img/进程创建.png)

- 创建新进程

```c
#include <unistd.h>

/*
此方法返回两次，
在父进程中返回创建子进程的id，如果失败则返回-1。
对于子进程总是返回0
*/
pid_t fork(void);
```



